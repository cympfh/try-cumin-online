<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Try Cumin Online</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js" ></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src='./pkg/cumin.js'></script>
    <script>
      function encodeBase64(text) {
        return btoa(unescape(encodeURIComponent(text)));
      }
      function decodeBase64(code) {
        return decodeURIComponent(escape(atob(code)));
      }
    </script>
    <script>
      var ready = false;
      var cumin = function(input) {
        console.error("wasm not loaded!?");
        return null;
      }
      const { load } = wasm_bindgen;
      async function run() {
        await wasm_bindgen('./pkg/cumin_bg.wasm');
        cumin = function(input) {
          var result = load(input);
          try {
            return [true, JSON.parse(result)];
          } catch(e) {
            return [false, result];
          }
        };
        console.log("wasm loaded");
        ready = true;
      }
      run();
    </script>
<style>
.textarea {
  height: 400px;
  line-height: normal;
  font-size: 1.0rem;
  font-family:
    'Noto Sans Mono CJK JP',
    'Source Han Code JP',
    'Ricty', 'Ricty Diminished', 'Ricty Diminished Discord',
    'Myrica M', 'MyricaM M',
    'Rounded M+ 1m regular',
    'Rounded M+ 2m regular',
    'Rounded Mgen+ 1m regular',
    'Rounded Mgen+ 2m regular',
    'Migu 1M', 'Migu 2M',
    'VL ゴシック',
    'M+ 1m', 'M+ 2m',
    'Yutapon coding Regular',
    SFMono-Regular,
    Consolas,
    'Roboto Mono',
    'Courier New',
    Courier,
    Meiryo,
    "Andale Mono WT", "Andale Mono",
    "Lucida Console", "Lucida Sans Typewriter",
    "DejaVu Sans Mono",
    "Bitstream Vera Sans Mono",
    "Liberation Mono",
    "Nimbus Mono L",
    Monaco,
    monospace;
}
</style>
  </head>
  <body>
    <noscript>This page contains webassembly and javascript content, please enable javascript in your browser.</noscript>
    <!-- <script src="./bootstrap.js"></script> -->

    <section class="section">
      <div class="container">
        <h1 class="title">Try Cumin Online <i class="fas fa-leaf"></i></h1>
        <h2 class="subtitle is-6">v0.9.12</h2>

        <div class="container" id="tco">
          <div class="columns">
            <div class="column">
              <div class="control">
                <textarea class="textarea"
                  v-model="input"
                  v-on:change="parse"
                  v-on:keyup="parse"
                ></textarea>
              </div>
              <div class="control">
                <button class="button is-warning is-light is-small"
                  v-on:click="share"
                ><i class="fas fa-share-square"></i>&nbsp; Share Code</button>
                <a class="button is-link is-light is-small"
                  href="http://cympfh.cc/cumin/"
                  target="_blank"
                > <i class="fas fa-book"></i>&nbsp; Learn Cumin</a>
                <div class="container"><div class="notification is-info is-light">{{console}}</div></div>
              </div>
            </div>
            <div class="column">
              <div class="control">
                <textarea class="textarea is-warning is-normal" placeholder="Primary textarea" readonly>{{ result }}</textarea>
              </div>
            </div>
          </div>
        </div>

      </div>
    </section>

    <script>
      var tco;
      window.addEventListener("load", () => {
        tco = new Vue({
          el: "#tco",
          data: {
            input: `// Cumin here

// Def of P.
struct P { x: Int, y: Int = 0 }

// P variables.
let p = P(1);  // (1, 0)
let q = P(2, 1);

// Function: Int -> P
let diagonal(x: Int) = P(x, x);

// List of P
[p, q, diagonal(10)]`,
            result: "// JSON here",
            console: "Wasm Loading...",
          },
          created: function() {
            this.load_from_hash();
          },
          methods: {
            parse() {
              var that = this;
              function doparse() {
                res = cumin(that.input);
                if (res[0]) {
                  that.result = JSON.stringify(res[1], null, "\t");
                  that.console = "Success";
                } else {
                  that.console = res[1];
                }
              }
              function wait() {
                if (!ready) {
                  setTimeout(wait, 100);
                } else {
                  doparse();
                }
              }
              wait();
            },
            load_from_hash() {
              var code = location.hash.slice(1);
              if (code) {
                try {
                  this.input = decodeBase64(code);
                  this.parse();
                } catch(err) {
                  console.error(err);
                }
              }
              this.parse();
            },
            share() {
              location.hash = "#" + encodeBase64(this.input);
              var tmp = document.createElement("input");
              document.body.appendChild(tmp);
              tmp.value = location.href;
              tmp.select();
              document.execCommand("copy");
              tmp.remove();
              this.console = "URL copied!";
            }
          }
        });
      });

      window.addEventListener("hashchange", () => {
        tco.load_from_hash();
      });
    </script>

  </body>
</html>

