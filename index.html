<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Try Cumin Online</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.1/css/bulma.min.css">
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js" ></script>
    <script src="https://cdn.jsdelivr.net/npm/vue"></script>
    <script src='./pkg/cumin.js'></script>
    <script>
      function encodeBase64(text) {
        return btoa(unescape(encodeURIComponent(text)));
      }
      function decodeBase64(code) {
        return decodeURIComponent(escape(atob(code)));
      }
    </script>
    <script>
      var ready = false;
      var cumin = function(input) {
        console.error("wasm not loaded!?");
        return null;
      }
      const { load } = wasm_bindgen;
      async function run() {
        await wasm_bindgen('./pkg/cumin_bg.wasm');
        cumin = function(input) {
          var result = load(input);
          try {
            return [true, JSON.parse(result)];
          } catch(e) {
            return [false, result];
          }
        };
        console.log("wasm loaded");
        ready = true;
      }
      run();
    </script>
<style>
.textarea {
  height: 400px;
}
</style>
  </head>
  <body>
    <noscript>This page contains webassembly and javascript content, please enable javascript in your browser.</noscript>
    <!-- <script src="./bootstrap.js"></script> -->

    <section class="section">
      <div class="container">
        <h1 class="title">Try Cumin Online</h1>

        <div class="container" id="tco">
          <div class="columns">
            <div class="column">
              <div class="control">
                <textarea class="textarea is-primary is-medium" placeholder="Primary textarea"
                  v-model="input"
                  v-on:change="parse"
                  v-on:keyup="parse"
                ></textarea>
              </div>
              <div class="control">
                <button class="button is-link is-light is-small"
                  v-on:click="share"
                  ><i class="fas fa-share-square"></i> Share Code</button>
                <div>{{err}}</div>
              </div>
            </div>
            <div class="column">
              <div class="control">
                <textarea class="textarea is-warning is-normal" placeholder="Primary textarea" readonly>{{ result }}</textarea>
              </div>
            </div>
          </div>
        </div>

      </div>
      <div class="container">
          <span class="subtitle">
            <a href="http://cympfh.cc/cumin/"> <i class="fas fa-book"></i> Learn Cumin</a>
          </span>
      </div>
    </section>

    <script>
      var tco;
      window.addEventListener("load", () => {
        tco = new Vue({
          el: "#tco",
          data: {
            input: `// Cumin here

struct P { x: Int, y: Int }
let p = P(0, 1 + 2);

struct Q { msg: String }
type D = P | Q;

[D(p), D.Q("Hello")]`,
            result: "// JSON here",
            err: "Wasm Loading...",
          },
          created: function() {
            this.load_from_hash();
          },
          methods: {
            parse() {
              var that = this;
              function doparse() {
                res = cumin(that.input);
                if (res[0]) {
                  that.result = JSON.stringify(res[1], null, "\t");
                  that.err = "";
                } else {
                  that.err = res[1];
                }
              }
              function wait() {
                if (!ready) {
                  setTimeout(wait, 100);
                } else {
                  doparse();
                }
              }
              wait();
            },
            load_from_hash() {
              var code = location.hash.slice(1);
              if (code) {
                try {
                  this.input = decodeBase64(code);
                  this.parse();
                } catch(err) {
                  console.error(err);
                }
              }
              this.parse();
            },
            share() {
              location.hash = "#" + encodeBase64(this.input);
              var tmp = document.createElement("input");
              document.body.appendChild(tmp);
              tmp.value = location.href;
              tmp.select();
              document.execCommand("copy");
              tmp.remove();
              this.err = "URL copied!";
            }
          }
        });
      });

      window.addEventListener("hashchange", () => {
        tco.load_from_hash();
      });
    </script>

  </body>
</html>

